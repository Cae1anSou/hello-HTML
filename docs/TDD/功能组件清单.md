### **功能组件清单  - V1.0**

**项目名称:** 自适应动态AI教学系统
**文档目的:** 聚合所有已确定的技术组件、数据模型和接口，作为最终版TDD的统一蓝图。

---

### **1. 后端核心服务/模块 (Backend Services)**

这些是在 `backend/app/services/` 目录下的核心逻辑单元。
### **1. 后端核心服务/模块 (Backend Services)**

| 服务/模块                      | 核心职责                                                   | 关键方法/逻辑                                                                                                     | 依赖的服务                                                             |
| :------------------------- | :----------------------------------------------------- | :---------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------- |
| `DynamicController`        | **核心业务编排器**。                                           | `generate_adaptive_response()`                                                                              | `UserStateService`, `RAGService`, `PromptGenerator`, `LLMGateway` |
| `UserStateService`         | 在**内存中**管理所有活跃用户的状态。                                   | `_get_or_create_profile()`, `update_from_behavior()`, `update_from_chat_sentiment()`, `get_model_summary()` | `SQLite DB`, **`SentimentAnalysisService`**                       |
| `SentimentAnalysisService` | **文本情感分析服务**。使用预训练的BERT模型，对用户的聊天消息进行情感分类（如：困惑、沮丧、好奇等）。 | `analyze_sentiment(text)`                                                                                   | `Hugging Face Transformers` / `PyTorch`                           |
| `RAGService`               | **检索增强生成服务**。                                          | `retrieve(query, k)`                                                                                        | `Embedding Model`, `Vector DB`                                    |
| `SandboxService`           | **安全代码评测服务**。                                          | `run_evaluation(code, checkpoints)`                                                                         | `Playwright`                                                      |
| `LLMGateway`               | **LLM API网关**。                                         | `get_completion(system_prompt, messages)`                                                                   | `OpenAI API`                                                      |
| `PromptGenerator`          | **动态Prompt生成器**。                                       | `create_prompts(...)`                                                                                       | -                                                                 |
| `PersistenceService`       | **异步持久化服务**。                                           | `save_event()`, `save_survey()`                                                                             | `SQLite DB`                                                       |


### **2. API 端点清单 (API Endpoints)**

所有API均以 `/api/v1` 为前缀。

| 方法     | 路径                             | 用途                               | 关键请求体/参数                                                                          | 成功响应                                                                     |
| :----- | :----------------------------- | :------------------------------- | :-------------------------------------------------------------------------------- | :----------------------------------------------------------------------- |
| `POST` | `/session/initiate`            | **会话启动/注册**。新用户创建，老用户登录。         | `{ "username": "..." }`                                                           | `{ "participant_id": "...", "is_new_user": ... }`                        |
| `GET`  | `/knowledge-graph`             | 获取**静态知识图谱**结构（节点和依赖边）。          | -                                                                                 | `{ "nodes": [...], "edges": [...] }`                                     |
| `GET`  | `/participants/{id}/progress`  | 获取指定用户的**学习进度**（已完成的知识点列表）。      | `participant_id` (路径参数)                                                           | `{ "completed_topics": [...] }`                                          |
| `GET`  | `/learning-content/{topic_id}` | 获取指定知识点的**学习材料**。                | `topic_id` (路径参数)                                                                 | `{ "code": {...}, "documentation": "..." }`                              |
| `GET`  | `/test-tasks/{topic_id}`       | 获取指定知识点的**测试任务**详情。              | `topic_id` (路径参数)                                                                 | `{ "description_md": "...", "start_code": {...}, "checkpoints": [...] }` |
| `POST` | `/ai/chat`                     | **核心AI对话**。发送用户消息和完整上下文，获取自适应回复。 | `{ "participant_id", "user_message", "history", "code_context", "task_context" }` | `{ "role": "ai", "content": "..." }`                                     |
| `POST` | `/submit-test`                 | **提交测试代码**进行评测。                  | `{ "participant_id", "topic_id", "code": {...} }`                                 | `{ "passed": bool, "message": "...", "details": [...] }`                 |
| `POST` | `/behavior/log`                | **记录用户行为**。由前端追踪器调用。             | `{ "participant_id", "event_type", "event_data" }`                                | `202 Accepted`                                                           |
| `GET`  | `/surveys/{type}`              | 获取指定类型的**问卷结构**。                 | `survey_type` (路径参数)                                                              | `{ "title": "...", "questions": [...] }`                                 |
| `POST` | `/surveys/submit`              | **提交问卷答案**。                      | `{ "participant_id", "survey_type", "answers": {...} }`                           | `200 OK`                                                                 |
| `GET`  | `/config`                      | **获取前端安全配置**。（目前为空，为未来预留）        | -                                                                                 | `{}`                                                                     |

---

### **3. 数据库模型 (Data Models / Tables)**

| 表名                   | 字段                                                                                                | 描述                                                                                                  |
| :------------------- | :------------------------------------------------------------------------------------------------ | :-------------------------------------------------------------------------------------------------- |
| **`participants`**   | `id` (PK, UUID/TEXT), `username` (UNIQUE), `group`, `created_at`                                  | 存储每个实验参与者的基本信息。                                                                                     |
| **`event_logs`**     | `id` (PK, INT), `participant_id` (FK), `timestamp`, `event_type`, `event_data` (JSON)             | **最重要的数据源**。记录所有由前端发送的原始行为痕迹。(可以考虑在`ai_chat`事件的`event_data`中增加一个`sentiment_result`字段来记录分析结果，便于事后分析) |
| **`chat_history`**   | `id` (PK, INT), `participant_id` (FK), `timestamp`, `role`, `message`, `raw_prompt_to_llm` (TEXT) | 记录完整的对话历史和用于生成AI回答的Prompt。                                                                          |
| **`survey_results`** | `id` (PK, INT), `participant_id` (FK), `survey_type`, `answers` (JSON), `submitted_at`            | 存储用户提交的所有问卷结果。                                                                                      |
| **`user_progress`**  | `id` (PK, INT), `participant_id` (FK), `topic_id` (TEXT), `completed_at`                          | **(优化决策)** 用于记录用户已完成的知识点。这比每次都从`event_logs`计算要高效得多。                                                 |

**设计决策/优化:**
*   我们决定增加一个 `user_progress` 表。虽然这个信息可以从 `event_logs` 中通过查询所有 `test_passed` 事件来推断，但拥有一个独立的进度表会让 `GET /participants/{id}/progress` 的查询效率极高，避免了对庞大的日志表进行扫描。这是一个典型的用空间换时间的性能优化。
*   我们不再需要 `state_snapshots` 表，因为实时的用户状态在内存中管理，而历史状态可以通过回放 `event_logs` 来重建，这对于科研的复现性更有价值。

---

### **4. 前端核心模块 (Frontend Modules)**

这些是在 `frontend/js/` 目录下的核心逻辑单元。

| 模块 | 核心职责 | 关键方法/逻辑 |
| :--- | :--- | :--- |
| **`session.js`** | **会话管理**。负责在`localStorage`中存取`participant_id`。 | `saveParticipantId()`, `getParticipantId()`, `isSessionActive()` |
| **`behavior_tracker.js`** | **全局行为追踪**。捕获代码编辑、AI求助、闲置、焦点变化等事件，并发送到后端。 | `logEvent()`, `initEventListeners()` |
| **`live_preview.js`** | **实时预览模块**。封装了编辑器与`iframe`之间的防抖动实时更新逻辑。 | `createLivePreview()` |
| **`api_client.js`** | **API客户端** (推荐)。将所有`fetch`调用封装起来，统一处理请求头、错误和响应解析。 | `get()`, `post()` |
| **`graph_renderer.js`** | **知识图谱渲染与交互**。负责将数据渲染成图，并处理节点点击事件。 | `renderGraph()`, `handleNodeClick()` |
| **`survey_renderer.js`** | **问卷渲染与提交**。负责动态生成问卷表单并处理提交逻辑。 | `renderSurvey()`, `handleSubmit()` |
| **`chat_ui.js`** | **AI对话界面管理**。负责构建上下文、发送请求、渲染对话历史（包括Markdown）。 | `sendMessage()`, `addMessageToUI()` |
